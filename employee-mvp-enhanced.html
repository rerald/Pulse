<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì£¼íœ´ìˆ˜ë‹¹ MVP ì§ì›í™”ë©´ (í”„ë¡ íŠ¸ì—”ë“œ ì™„ì„±)</title>
  <!-- Supabase ì—°ê²° -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <style>
    :root{
      --bg:#f7f8fa; --text:#111; --muted:#6b7684; --line:#eaecef;
      --blue:#1672F3; --green:#12B886; --red:#ff6b6b; --chip:#f1f3f5;
    }
    *{ box-sizing:border-box; font-family: ui-sans-serif, -apple-system, 'Segoe UI', Roboto, 'Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic', sans-serif; }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:424px; margin:0 auto; padding:20px; }
    h2{ margin:0 0 12px; font-weight:700; }
    h3{ margin:0 0 10px; font-weight:700; font-size:16px; }
    h4{ margin:0 0 10px; font-weight:700; font-size:15px; }
    .muted{ color:var(--muted); font-size:12px; }

    /* Inputs */
    .field-row{ display:flex; gap:10px; align-items:flex-start; }
    .field{ flex:1; min-width:0; }
    .label-row{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:6px 0; }
    input[type=number]{ width:100%; height:44px; padding:0 10px; border:1px solid var(--line); border-radius:12px; background:#fff; }

    /* íƒ€ì„í”¼ì»¤: í‘œì‹œ ì „ìš©(í° ê¸€ì”¨) + í´ë¦­ ê°€ëŠ¥í•œ ë„¤ì´í‹°ë¸Œ ì…ë ¥ */
    .time-box{ position:relative; cursor:pointer; }
    .time-display{ height:60px; display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:700; border:1px solid var(--line); border-radius:12px; background:#fff; color:#111; margin-top:2px; transition:border-color 0.2s ease; }
    .time-display:hover{ border-color:var(--blue); }
    .time-native{ position:absolute; inset:0; opacity:0; -webkit-appearance:none; appearance:none; border:none; width:100%; height:100%; z-index:3; cursor:pointer; }

    /* Components */
    .card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; box-shadow:0 1px 0 rgba(0,0,0,.03); }
    .card-strong{ border-color:#d5d9e3; box-shadow:0 2px 0 rgba(0,0,0,.04); }
    .row-card{ position:relative; }
    .btn-primary{ width:100%; height:52px; border:none; border-radius:12px; background:var(--blue); color:#fff; font-weight:700; font-size:16px; }
    .chip{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; background:var(--chip); color:#3f474f; font-size:12px; }
    .chip-ok{ color:#0f7b57; background:#eaf7f1; border-color:#d8efe5; }
    .chip-warn{ color:#6b7684; background:#f3f4f6; border-color:var(--line); }
    .tag{ display:inline-block; padding:2px 6px; border:1px solid var(--line); border-radius:999px; background:#fff; color:#334; font-size:11px; margin-right:6px; }
    .tag-blue{ background:#e7efff; border-color:#c9d3ea; color:#1a2a52; }
    .badge{ font-size:11px; padding:1px 6px; border:1px solid #c9d3ea; border-radius:999px; background:#e7efff; color:#1a2a52; white-space:nowrap; display:inline-flex; align-items:center; line-height:1; }
    .link-soft{ position:absolute; right:12px; top:12px; color:#6b7684; text-decoration:none; font-size:12px; }

    /* Title row + calendar icon */
    .title-row{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .icon-btn{ display:inline-flex; width:32px; height:32px; border:1px solid var(--line); border-radius:8px; align-items:center; justify-content:center; background:#fff; cursor:pointer; }
    .icon-btn svg{ width:18px; height:18px; fill:#6b7684; }

    /* Accordion (week group) */
    details.week{ margin:8px 0; }
    details.week > summary{ list-style:none; cursor:pointer; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; font-weight:700; }
    details.week[open] > summary{ border-color:#dfe3ea; }
    .week-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .kpis{ display:flex; gap:6px; }

    /* Status dots */
    .dot{ display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px; vertical-align:middle; }
    .ok{ background:var(--green); }
    .wait{ background:#adb5bd; }
    .reject{ background:var(--red); }

    /* fixed bottom bar */
    .fixed-bar{ position:fixed; left:0; right:0; bottom:0; background:#ffffff; border-top:1px solid var(--line); padding:12px 16px calc(12px + env(safe-area-inset-bottom)); box-shadow:0 -2px 12px rgba(0,0,0,.06); }
    .fixed-spacer{ height:76px; }

    /* snackbar */
    .snackbar{ position:fixed; left:50%; transform:translateX(-50%); bottom:calc(72px + env(safe-area-inset-bottom)); background:#111; color:#fff; padding:10px 14px; border-radius:12px; font-size:14px; box-shadow:0 6px 18px rgba(0,0,0,.2); opacity:0; pointer-events:none; transition:opacity .25s ease, transform .25s ease; display:flex; gap:12px; align-items:center; }
    .snackbar.show{ opacity:1; transform:translateX(-50%) translateY(-6px); pointer-events:auto; }
    .snackbar .action{ background:transparent; border:1px solid #fff; color:#fff; border-radius:999px; padding:6px 10px; font-size:12px; line-height:1; cursor:pointer; }

    /* today line */
    .today-line{ 
      margin-top:4px; 
      font-size:12px; 
      color:var(--muted); 
      cursor:pointer; 
      transition: all 0.2s ease;
      user-select: none;
      padding: 8px 12px;
      margin: 0 -12px 8px -12px;
      border-radius: 6px;
    }
    .today-line:hover {
      color: var(--blue);
      background: var(--bg);
    }
    .today-line:active {
      transform: scale(0.98);
    }

    /* Calendar fullscreen (z-index high) */
    .calendar-page{ position:fixed; inset:0; background:#fff; z-index:9999; display:none; flex-direction:column; }
    .cal-head{ display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--line); }
    .cal-head strong{ font-size:16px; }
    .cal-nav{ display:flex; gap:8px; }
    .cal-grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; padding:12px 12px 16px; }
    .cal-cell{ border:1px solid var(--line); border-radius:10px; min-height:64px; padding:6px; display:flex; flex-direction:column; justify-content:space-between; }
    .cal-date{ font-size:12px; color:#6b7684; }
    .cal-hrs{ font-weight:700; font-size:14px; }
    .cal-badge{ font-size:11px; padding:2px 6px; border-radius:999px; align-self:flex-start; }
    .b-normal{ background:#eaf7f1; color:#0f7b57; }
    .b-late{ background:#fff3cd; color:#8a6d3b; }
    .b-absent{ background:#ffe3e3; color:#c92a2a; }
    .cal-legend{ display:flex; gap:8px; padding:0 16px 12px; color:#6b7684; font-size:12px; }

    /* ì‹¤ì‹œê°„ ê³„ì‚° ê²°ê³¼ ê°•ì¡° */
    .calc-result{ background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:8px; margin-top:8px; }
    .calc-item{ display:flex; justify-content:space-between; align-items:center; margin:4px 0; }
    .calc-label{ font-size:12px; color:var(--muted); }
    .calc-value{ font-weight:700; font-size:14px; }
    .calc-value.highlight{ color:var(--blue); font-size:16px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title-row">
      <h2>ì§ì› í™”ë©´ (MVP)</h2>
      <button class="icon-btn" id="btn-open-cal" type="button" title="ê·¼ë¬´ ìº˜ë¦°ë”" onclick="openCalendarPage()">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a2 2 0 0 1 2 2v3H3V6a2 2 0 0 1 2-2h1V3a1 1 0 1 1 2 0v1zM3 10h18v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2zM7 13h3v3H7zM12 13h3v3h-3zM17 13h3v3h-3z"/></svg>
      </button>
    </div>

    <div class="card card-strong" style="margin-bottom:12px;">
      <div class="title-row"><h3>ì˜¤ëŠ˜ ê·¼ë¬´ ê¸°ë¡</h3><span class="chip" id="empName">í™ê¸¸ë™</span></div>
      <div class="today-line" id="today-line" onclick="openDatePicker()">ì˜¤ëŠ˜: <span id="today-date"></span></div>

      <div class="field-row" style="margin-top:8px;">
        <div class="field">
          <div class="label-row"><label for="inTime">ì¶œê·¼ ì‹œê°„</label></div>
          <div class="time-box">
            <div class="time-display" id="inTimeDisplay">09:00</div>
            <input type="time" id="inTime" class="time-native" value="09:00" data-default="09:00" />
          </div>
        </div>
        <div class="field">
          <div class="label-row"><label for="outTime">í‡´ê·¼ ì‹œê°„</label></div>
          <div class="time-box">
            <div class="time-display" id="outTimeDisplay">18:00</div>
            <input type="time" id="outTime" class="time-native" value="18:00" data-default="18:00" />
          </div>
        </div>
      </div>

      <div class="field" style="margin-top:8px;">
        <label for="breakMin">íœ´ê²Œ ì‹œê°„(ë¶„)</label>
        <input type="number" id="breakMin" value="60" min="0" step="5" />
      </div>

      <!-- ì‹¤ì‹œê°„ ê³„ì‚° ê²°ê³¼ -->
      <div class="calc-result" id="calc-result" style="display:none;">
        <div class="calc-item">
          <span class="calc-label">ì˜¤ëŠ˜ ì‹¤ê·¼ë¡œì‹œê°„</span>
          <span class="calc-value" id="work-hours">0.0h</span>
        </div>
        <div class="calc-item">
          <span class="calc-label">ì´ë²ˆ ë‹¬ ëˆ„ì ì‹œê°„</span>
          <span class="calc-value" id="month-total">0.0h</span>
        </div>
        <div class="calc-item">
          <span class="calc-label">ëˆ„ì  ê¸‰ì—¬</span>
          <span class="calc-value" id="total-salary">0ì›</span>
        </div>
        <div class="calc-item">
          <span class="calc-label">ëˆ„ì  ì£¼íœ´ìˆ˜ë‹¹</span>
          <span class="calc-value" id="total-allowance">0ì›</span>
        </div>
        <div class="calc-item">
          <span class="calc-label">í˜„ì¬ ë°›ì„ ì´ê¸‰ì—¬</span>
          <span class="calc-value highlight" id="total-payment">0ì›</span>
        </div>
      </div>

      <div class="muted" style="margin-top:8px;">ì „ë‚  ë˜ëŠ” ìš”ì¼ ê¸°ë³¸ê°’ì„ ìë™ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ë³€ê²½ ì‹œë§Œ ìˆ˜ì •í•˜ì„¸ìš”.</div>
    </div>

    <div class="card" style="margin-bottom:12px; display:flex; gap:8px; align-items:center;">
      <span class="chip" id="month-summary">ì´ë²ˆ ë‹¬ ëˆ„ì  ê·¼ë¬´ 0.0h</span>
      <span class="chip" id="attendance-status">ê°œê·¼ ì˜ˆ</span>
      <span class="chip" id="allowance-summary">ëˆ„ì  ì£¼íœ´ìˆ˜ë‹¹ 0ì›</span>
    </div>

    <h4>ê·¼ë¬´ ê¸°ë¡ íˆìŠ¤í† ë¦¬ (ìµœì‹ ìˆœ)</h4>

    <div id="history-container">
      <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  íˆìŠ¤í† ë¦¬ -->
    </div>

    <p class="muted">â€» ë³¸ ê³„ì‚°ì€ ì…ë ¥ê°’ê³¼ ë‹¨ìˆœ ê·œì¹™ì— ë”°ë¥¸ ì°¸ê³ ì¹˜ì…ë‹ˆë‹¤. ìµœì¢… í™•ì •ì€ ì‚¬ì—…ì£¼ì˜ ì±…ì„ì…ë‹ˆë‹¤.</p>
  </div>

  <div class="fixed-spacer"></div>
  <div class="fixed-bar">
    <div class="wrap" style="max-width:424px; padding:0;">
      <button class="btn-primary" id="submit-btn" type="button">ê²€í†  ì™„ë£Œ í›„ ì œì¶œ</button>
    </div>
  </div>

  <!-- snackbar -->
  <div id="snackbar" class="snackbar"><span id="snackbar-text">ì œì¶œ ì™„ë£Œ. ì‚¬ì¥ ìŠ¹ì¸ ëŒ€ê¸°ì…ë‹ˆë‹¤.</span><button id="snackbar-action" class="action" type="button">íˆìŠ¤í† ë¦¬ë¡œ ì´ë™</button></div>

  <!-- Bottom Sheet Modal -->
  <div id="sheet-overlay" onclick="closeSheet()" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,.35);"></div>
  <div id="sheet" style="position:fixed; left:0; right:0; bottom:-100%; background:#fff; border-top-left-radius:16px; border-top-right-radius:16px; box-shadow:0 -8px 24px rgba(0,0,0,.12); transition:bottom .25s ease; max-height:70vh; overflow:auto;">
    <div class="header" style="padding:14px 16px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center;">
      <strong id="sheet-title">ìƒì„¸</strong>
      <a href="#" onclick="closeSheet(); return false;" class="muted">ë‹«ê¸°</a>
    </div>
    <div id="sheet-body" style="padding:14px 16px; font-size:14px; color:#333;"></div>
  </div>

  <!-- Calendar full page -->
  <div id="calendar-page" class="calendar-page">
    <div class="cal-head">
      <button class="icon-btn" id="cal-prev" title="ì´ì „ ë‹¬" type="button"><svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button>
      <strong id="cal-title">YYYY-MM</strong>
      <div class="cal-nav">
        <button class="icon-btn" id="cal-today" title="ì˜¤ëŠ˜" type="button"><svg viewBox="0 0 24 24"><path d="M12 8v4l3 3"/></svg></button>
        <button class="icon-btn" id="cal-next" title="ë‹¤ìŒ ë‹¬" type="button"><svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg></button>
        <button class="icon-btn" id="cal-close" title="ë‹«ê¸°" type="button"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
      </div>
    </div>
    <div class="cal-legend">
      <span class="cal-badge b-normal">ì •ìƒ</span>
      <span class="cal-badge b-late">ì§€ê°</span>
      <span class="cal-badge b-absent">ê²°ê·¼</span>
    </div>
    <div class="cal-grid" id="cal-grid"></div>
  </div>

  <!-- Date Picker Modal -->
  <div id="date-picker-overlay" onclick="closeDatePicker()" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,.35); z-index:10000;"></div>
  <div id="date-picker-modal" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%, -50%); background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.12); z-index:10001; min-width:320px; max-width:90vw;">
    <div class="header" style="padding:16px 20px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center;">
      <strong>ë‚ ì§œ ì„ íƒ</strong>
      <a href="#" onclick="closeDatePicker(); return false;" class="muted">ë‹«ê¸°</a>
    </div>
    <div style="padding:20px;">
      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:14px; color:var(--muted); margin-bottom:8px;">ê·¼ë¬´ ê¸°ë¡í•  ë‚ ì§œ</label>
        <input type="date" id="selected-date" style="width:100%; height:44px; padding:0 12px; border:1px solid var(--line); border-radius:8px; background:#fff; font-size:16px;" />
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button onclick="closeDatePicker()" style="padding:8px 16px; border:1px solid var(--line); border-radius:8px; background:#fff; color:var(--text); cursor:pointer;">ì·¨ì†Œ</button>
        <button onclick="loadSelectedDate()" style="padding:8px 16px; border:none; border-radius:8px; background:var(--blue); color:#fff; cursor:pointer;">ì„ íƒ</button>
      </div>
    </div>
  </div>

  <script>
    // ===== ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì • =====
    const HOURLY_WAGE = 12000; // ì‹œê¸‰ (ê¸°ë³¸ê°’)
    const EXPECTED_SCHEDULE = { start: '09:00', end: '18:00', breakMin: 60 };
    
    // í˜„ì¬ ì„ íƒëœ ë‚ ì§œ (ê¸°ë³¸ê°’: ì˜¤ëŠ˜)
    let currentSelectedDate = getDateString();
    
    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í‚¤
    const STORAGE_KEYS = {
      WORK_LOGS: 'workLogs',
      EMPLOYEE_NAME: 'employeeName',
      HOURLY_WAGE: 'hourlyWage',
      EMPLOYEE_ID: 'employeeId'
    };

    // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
    function hmToMinutes(hm) {
      if (!hm) return 0;
      const parts = hm.split(':');
      const hours = parseInt(parts[0] || '0', 10);
      const minutes = parseInt(parts[1] || '0', 10);
      return hours * 60 + minutes;
    }

    function minutesToHours(minutes) {
      return (Math.max(0, minutes) / 60).toFixed(1);
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
    }

    function getDateString(date = new Date()) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function getWeekRange(date = new Date()) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // ì›”ìš”ì¼ ì‹œì‘
      const start = new Date(d.setDate(diff));
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      
      // ì •í™•í•œ ì£¼ì°¨ ê³„ì‚°
      const firstDayOfMonth = new Date(start.getFullYear(), start.getMonth(), 1);
      const firstMonday = new Date(firstDayOfMonth);
      const firstDay = firstDayOfMonth.getDay();
      const daysToFirstMonday = firstDay === 0 ? 1 : 8 - firstDay;
      firstMonday.setDate(1 + daysToFirstMonday);
      
      const weekNumber = Math.ceil((start - firstMonday) / (7 * 24 * 60 * 60 * 1000)) + 1;
      
      return {
        start: getDateString(start),
        end: getDateString(end),
        year: start.getFullYear(),
        month: start.getMonth() + 1,
        week: Math.max(1, weekNumber)
      };
    }

    // ===== ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° =====
    function calculateWeeklyAllowance(totalHours, hourlyWage = HOURLY_WAGE) {
      if (totalHours >= 15) { // ì£¼íœ´ìˆ˜ë‹¹ ìš”ê±´ (15ì‹œê°„ ì´ìƒ)
        const allowance = (totalHours / 40) * 8 * hourlyWage;
        console.log(`ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚°: ${totalHours}ì‹œê°„ Ã· 40ì‹œê°„ Ã— 8ì‹œê°„ Ã— ${hourlyWage}ì› = ${allowance}ì›`);
        return allowance;
      }
      return 0;
    }

    function calculateWorkHours(inTime, outTime, breakMin) {
      const inMinutes = hmToMinutes(inTime);
      const outMinutes = hmToMinutes(outTime);
      const breakMinutes = parseInt(breakMin) || 0;
      const totalMinutes = Math.max(0, outMinutes - inMinutes - breakMinutes);
      return totalMinutes / 60;
    }

    function getAttendanceStatus(workHours, inTime) {
      if (workHours === 0) return 'absent';
      const expectedIn = hmToMinutes(EXPECTED_SCHEDULE.start);
      const actualIn = hmToMinutes(inTime);
      if (actualIn > expectedIn) return 'late';
      return 'normal';
    }

    // ===== ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸ =====
    async function checkDatabaseConnection() {
      try {
        console.log('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...');
        
        // ê°„ë‹¨í•œ ì¿¼ë¦¬ë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸
        const { data, error } = await supabase
          .from('work_logs')
          .select('count')
          .limit(1);

        if (error) {
          console.error('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨:', error);
          return false;
        }

        console.log('âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ');
        return true;
      } catch (error) {
        console.error('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜:', error);
        return false;
      }
    }

    // ===== Supabase ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ =====
    async function saveWorkLog(date, log) {
      try {
        console.log(`ğŸ“ ê·¼ë¬´ ê¸°ë¡ ì €ì¥ ì‹œë„: ${date}`, log);
        
        const workHours = calculateWorkHours(log.in, log.out, log.breakMin);
        const status = getAttendanceStatus(workHours, log.in);
        const employeeId = getEmployeeId();
        
        console.log('ì €ì¥í•  ë°ì´í„°:', {
          id: `LOG_${date}_${getEmployeeName()}`,
          employee_id: employeeId,
          work_date: date,
          clock_in: log.in,
          clock_out: log.out,
          break_minutes: parseInt(log.breakMin) || 0,
          work_hours: workHours,
          status: status,
          approval_status: log.approved ? 'approved' : 'pending'
        });
        
        const { data, error } = await supabase
          .from('work_logs')
          .upsert({
            id: `LOG_${date}_${getEmployeeName()}`,
            employee_id: employeeId,
            work_date: date,
            clock_in: log.in,
            clock_out: log.out,
            break_minutes: parseInt(log.breakMin) || 0,
            work_hours: workHours,
            status: status,
            approval_status: log.approved ? 'approved' : 'pending',
            note: log.note || null,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          });

        if (error) {
          console.error('âŒ ê·¼ë¬´ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
          console.error('ì˜¤ë¥˜ ìƒì„¸:', {
            message: error.message,
            details: error.details,
            hint: error.hint,
            code: error.code
          });
          // ì‹¤íŒ¨ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ë°±ì—… ì €ì¥
          console.log('ğŸ”„ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ë°±ì—… ì €ì¥');
          return saveWorkLogLocal(date, log);
        }

        console.log('âœ… ê·¼ë¬´ ê¸°ë¡ ì €ì¥ ì„±ê³µ:', data);
        return data;
      } catch (error) {
        console.error('âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨:', error);
        // ì˜¤í”„ë¼ì¸ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        console.log('ğŸ”„ ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥');
        return saveWorkLogLocal(date, log);
      }
    }

    async function getWorkLogs() {
      try {
        const { data, error } = await supabase
          .from('work_logs')
          .select('*')
          .eq('employee_id', getEmployeeId())
          .order('work_date', { ascending: false });

        if (error) {
          console.error('ê·¼ë¬´ ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
          return getWorkLogsLocal();
        }

        // ë°ì´í„°ë² ì´ìŠ¤ í˜•ì‹ì„ ë¡œì»¬ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        const logs = {};
        data.forEach(log => {
          logs[log.work_date] = {
            in: log.clock_in,
            out: log.clock_out,
            breakMin: log.break_minutes,
            workHours: log.work_hours,
            status: log.status,
            approved: log.approval_status === 'approved',
            note: log.note,
            timestamp: log.created_at
          };
        });

        console.log('ê·¼ë¬´ ê¸°ë¡ ì¡°íšŒ ì„±ê³µ:', Object.keys(logs).length, 'ê°œ');
        return logs;
      } catch (error) {
        console.error('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨:', error);
        return getWorkLogsLocal();
      }
    }

    // ===== ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë°±ì—… (ì˜¤í”„ë¼ì¸ ëŒ€ì‘) =====
    function saveWorkLogLocal(date, log) {
      const logs = getWorkLogsLocal();
      logs[date] = {
        ...log,
        timestamp: new Date().toISOString(),
        workHours: calculateWorkHours(log.in, log.out, log.breakMin),
        status: getAttendanceStatus(calculateWorkHours(log.in, log.out, log.breakMin), log.in)
      };
      localStorage.setItem(STORAGE_KEYS.WORK_LOGS, JSON.stringify(logs));
      console.log('ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ë°±ì—… ì €ì¥:', date);
      return logs;
    }

    function getWorkLogsLocal() {
      try {
        const stored = localStorage.getItem(STORAGE_KEYS.WORK_LOGS);
        return stored ? JSON.parse(stored) : {};
      } catch (e) {
        console.warn('ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì½ê¸° ì‹¤íŒ¨:', e);
        return {};
      }
    }

    // ===== ì§ì› ì •ë³´ ê´€ë¦¬ =====
    function getEmployeeId() {
      // ì„ì‹œë¡œ ì§ì›ëª…ì„ IDë¡œ ì‚¬ìš© (ì‹¤ì œë¡œëŠ” ë¡œê·¸ì¸ ì‹œìŠ¤í…œì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
      return localStorage.getItem(STORAGE_KEYS.EMPLOYEE_ID) || 'EMP001';
    }

    function saveEmployeeId(id) {
      localStorage.setItem(STORAGE_KEYS.EMPLOYEE_ID, id);
    }

    async function getEmployeeInfo() {
      try {
        const { data, error } = await supabase
          .from('employees')
          .select('*')
          .eq('id', getEmployeeId())
          .single();

        if (error) {
          console.error('ì§ì› ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
          return getEmployeeInfoLocal();
        }

        console.log('ì§ì› ì •ë³´ ì¡°íšŒ ì„±ê³µ:', data);
        return data;
      } catch (error) {
        console.error('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨:', error);
        return getEmployeeInfoLocal();
      }
    }

    function getEmployeeInfoLocal() {
      return {
        name: getEmployeeName(),
        hourly_wage: getHourlyWage()
      };
    }

    function saveEmployeeName(name) {
      localStorage.setItem(STORAGE_KEYS.EMPLOYEE_NAME, name);
    }

    function getEmployeeName() {
      return localStorage.getItem(STORAGE_KEYS.EMPLOYEE_NAME) || 'í™ê¸¸ë™';
    }

    function saveHourlyWage(wage) {
      localStorage.setItem(STORAGE_KEYS.HOURLY_WAGE, wage.toString());
    }

    function getHourlyWage() {
      const stored = localStorage.getItem(STORAGE_KEYS.HOURLY_WAGE);
      return stored ? parseInt(stored, 10) : HOURLY_WAGE;
    }

    // ===== ì‹¤ì‹œê°„ ê³„ì‚° ì—…ë°ì´íŠ¸ =====
    async function updateCalculations() {
      const inTime = document.getElementById('inTime').value;
      const outTime = document.getElementById('outTime').value;
      const breakMin = document.getElementById('breakMin').value;

      if (!inTime || !outTime) {
        document.getElementById('calc-result').style.display = 'none';
        return;
      }

      const workHours = calculateWorkHours(inTime, outTime, breakMin);
      const today = getDateString();
      const logs = await getWorkLogs();
      const hourlyWage = getHourlyWage();
      
      // ì´ë²ˆ ë‹¬ ëˆ„ì  ê·¼ë¬´ì‹œê°„ ê³„ì‚°
      const currentDate = new Date();
      const currentMonth = currentDate.getMonth();
      const currentYear = currentDate.getFullYear();
      let monthTotal = 0;
      let totalSalary = 0;
      let totalAllowance = 0;
      
      // ì´ë²ˆ ë‹¬ì˜ ëª¨ë“  ê¸°ë¡ì„ ìˆœíšŒí•˜ì—¬ ê¸°ë³¸ê¸‰ ê³„ì‚°
      Object.keys(logs).forEach(dateStr => {
        const logDate = new Date(dateStr);
        if (logDate.getMonth() === currentMonth && logDate.getFullYear() === currentYear) {
          const logHours = logDate.toDateString() === new Date(today).toDateString() ? workHours : (logs[dateStr].workHours || 0);
          monthTotal += logHours;
          totalSalary += logHours * hourlyWage;
        }
      });
      
      // ì˜¤ëŠ˜ ê·¼ë¬´ì‹œê°„ì´ ì•„ì§ ì €ì¥ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì¶”ê°€
      if (!logs[today]) {
        monthTotal += workHours;
        totalSalary += workHours * hourlyWage;
      }
      
      // ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° (ë…¸ë™ë²• ê¸°ì¤€: ì£¼ ë‹¨ìœ„ë¡œ ê³„ì‚°, ì£¼ì˜ ë§ˆì§€ë§‰ ë‚ ì´ ì†í•œ ë‹¬ì˜ ê¸‰ì—¬ì— í¬í•¨)
      const processedWeeks = new Set();
      const allowanceDetails = []; // ë””ë²„ê¹…ìš©
      
      Object.keys(logs).forEach(dateStr => {
        const logDate = new Date(dateStr);
        const weekRange = getWeekRange(logDate);
        const weekKey = weekRange.start + '_' + weekRange.end;
        
        // ì´ë¯¸ ì²˜ë¦¬ëœ ì£¼ê°€ ì•„ë‹ˆë©´ ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚°
        if (!processedWeeks.has(weekKey)) {
          processedWeeks.add(weekKey);
          
          // í•´ë‹¹ ì£¼ì˜ ëª¨ë“  ê·¼ë¬´ì‹œê°„ ê³„ì‚°
          let weekTotal = 0;
          for (let d = new Date(weekRange.start); d <= new Date(weekRange.end); d.setDate(d.getDate() + 1)) {
            const weekDateStr = getDateString(d);
            if (logs[weekDateStr] && logs[weekDateStr].workHours) {
              weekTotal += logs[weekDateStr].workHours;
            }
          }
          
          // ì˜¤ëŠ˜ ê·¼ë¬´ì‹œê°„ì´ í•´ë‹¹ ì£¼ì— í¬í•¨ë˜ë©´ ì¶”ê°€
          const todayDate = new Date(today);
          if (todayDate >= new Date(weekRange.start) && todayDate <= new Date(weekRange.end)) {
            if (!logs[today]) {
              weekTotal += workHours;
            } else {
              weekTotal += logs[today].workHours || 0;
            }
          }
          
          // ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° (15ì‹œê°„ ì´ìƒì´ë©´)
          if (weekTotal >= 15) {
            const weekAllowance = calculateWeeklyAllowance(weekTotal, hourlyWage);
            
            // ì£¼ì˜ ë§ˆì§€ë§‰ ë‚ ì´ í˜„ì¬ ë‹¬ì— ì†í•˜ë©´ ì£¼íœ´ìˆ˜ë‹¹ í¬í•¨
            const weekEndDate = new Date(weekRange.end);
            if (weekEndDate.getMonth() === currentMonth && weekEndDate.getFullYear() === currentYear) {
              totalAllowance += weekAllowance;
              allowanceDetails.push({
                week: `${weekRange.start} ~ ${weekRange.end}`,
                hours: weekTotal,
                allowance: weekAllowance,
                month: weekEndDate.getMonth() + 1
              });
            }
          }
        }
      });
      
      // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
      console.log('=== ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° ìƒì„¸ ===');
      console.log('í˜„ì¬ ë‹¬:', currentMonth + 1, 'ì›”');
      console.log('ì´ ì£¼íœ´ìˆ˜ë‹¹:', totalAllowance, 'ì›');
      allowanceDetails.forEach(detail => {
        console.log(`- ${detail.week}: ${detail.hours}ì‹œê°„ â†’ ${detail.allowance}ì› (${detail.month}ì›” ê¸‰ì—¬ì— í¬í•¨)`);
      });

      const totalPayment = totalSalary + totalAllowance;

      // UI ì—…ë°ì´íŠ¸
      document.getElementById('work-hours').textContent = workHours.toFixed(1) + 'h';
      document.getElementById('month-total').textContent = monthTotal.toFixed(1) + 'h';
      document.getElementById('total-salary').textContent = formatCurrency(totalSalary);
      document.getElementById('total-allowance').textContent = formatCurrency(totalAllowance);
      document.getElementById('total-payment').textContent = formatCurrency(totalPayment);
      
      // í•˜ë‹¨ ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
      document.getElementById('month-summary').textContent = `ì´ë²ˆ ë‹¬ ëˆ„ì  ê·¼ë¬´ ${monthTotal.toFixed(1)}h`;
      document.getElementById('allowance-summary').textContent = `ëˆ„ì  ì£¼íœ´ìˆ˜ë‹¹ ${formatCurrency(totalAllowance)}`;
      
      // ê°œê·¼ ì—¬ë¶€ íŒë‹¨ (ì£¼ ë‹¨ìœ„ ê¸°ì¤€)
      const weekRange = getWeekRange();
      let weekTotal = 0;
      for (let d = new Date(weekRange.start); d <= new Date(weekRange.end); d.setDate(d.getDate() + 1)) {
        const dateStr = getDateString(d);
        if (logs[dateStr] && logs[dateStr].workHours) {
          weekTotal += logs[dateStr].workHours;
        }
      }
      
      if (!logs[today]) {
        weekTotal += workHours;
      } else {
        weekTotal += logs[today].workHours || 0;
      }
      
      const attendanceStatus = weekTotal >= 15 ? 'ê°œê·¼ ì˜ˆ' : 'ê°œê·¼ ë¶ˆê°€';
      document.getElementById('attendance-status').textContent = attendanceStatus;
      document.getElementById('attendance-status').className = weekTotal >= 15 ? 'chip chip-ok' : 'chip chip-warn';

      document.getElementById('calc-result').style.display = 'block';
    }

    // ===== íˆìŠ¤í† ë¦¬ ë Œë”ë§ =====
    async function renderHistory() {
      const logs = await getWorkLogs();
      const historyContainer = document.getElementById('history-container');
      
      if (Object.keys(logs).length === 0) {
        historyContainer.innerHTML = '<p class="muted">ì•„ì§ ê·¼ë¬´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í•‘
      const sortedDates = Object.keys(logs).sort((a, b) => new Date(b) - new Date(a));
      const weekGroups = {};
      
      sortedDates.forEach(date => {
        const weekRange = getWeekRange(new Date(date));
        const weekKey = `${weekRange.year}-${weekRange.month} ${weekRange.week}ì£¼ì°¨`;
        
        if (!weekGroups[weekKey]) {
          weekGroups[weekKey] = {
            range: weekRange,
            logs: []
          };
        }
        weekGroups[weekKey].logs.push({ date, ...logs[date] });
      });

      let html = '';
      
      // ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° ë° í‘œì‹œ
      Object.keys(weekGroups).forEach(weekKey => {
        const group = weekGroups[weekKey];
        const weekTotal = group.logs.reduce((sum, log) => sum + (log.workHours || 0), 0);
        const allowance = calculateWeeklyAllowance(weekTotal, getHourlyWage());
        const hasAllowance = weekTotal >= 15;
        
        html += `
          <details class="week" ${Object.keys(weekGroups).indexOf(weekKey) === 0 ? 'open' : ''}>
            <summary>
              <div class="week-head">
                <div>${weekKey} (${group.range.start}~${group.range.end})</div>
                <div class="kpis">
                  <span class="chip">ì´ê·¼ë¡œ ${weekTotal.toFixed(1)}h</span>
                  <span class="chip ${hasAllowance ? 'chip-ok' : 'chip-warn'}">${hasAllowance ? 'ê°œê·¼ ì˜ˆ' : 'ê°œê·¼ ë¶ˆê°€'}</span>
                </div>
              </div>
            </summary>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
        `;
        
        // ì£¼íœ´ìˆ˜ë‹¹ ì¹´ë“œ ì¶”ê°€
        if (hasAllowance) {
          html += `
            <div class="card row-card">
              <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                <div><span class="tag tag-blue">ì£¼íœ´</span><strong>${weekKey} ì£¼íœ´ìˆ˜ë‹¹ ${formatCurrency(allowance)}</strong></div>
                <span class="badge">ì‚¬ì¥ ìŠ¹ì¸ ì „</span>
              </div>
              <div class="muted" style="margin-top:6px;">ì‚°ì‹: (ì£¼${weekTotal.toFixed(0)}/40)Ã—8Ã—${formatCurrency(getHourlyWage())} = ${formatCurrency(allowance)}</div>
              <a href="#" class="link-soft" onclick="openSheet('ì£¼íœ´ìˆ˜ë‹¹ ìƒì„¸','<div><b>ì£¼ì°¨</b> ${weekKey} (${group.range.start}~${group.range.end})</div><div><b>ì£¼ ì´ê·¼ë¡œ</b> ${weekTotal.toFixed(1)}h</div><div><b>ìš”ê±´</b> 15h ì´ìƒ Â· ê°œê·¼</div><div><b>ì‚°ì‹</b> (${weekTotal.toFixed(0)}/40)Ã—8Ã—${formatCurrency(getHourlyWage())}</div><div><b>ê¸ˆì•¡</b> ${formatCurrency(allowance)}</div>'); return false;" style="position:static; margin-top:6px;">ìƒì„¸ë³´ê¸°</a>
            </div>
          `;
        }
        
        // ê·¼ë¬´ ê¸°ë¡ ì¹´ë“œë“¤
        group.logs.forEach(log => {
          const date = new Date(log.date);
          const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
          const dayName = dayNames[date.getDay()];
          const formattedDate = `${date.getMonth() + 1}/${date.getDate().toString().padStart(2, '0')} (${dayName})`;
          
          const statusClass = log.status === 'ì •ìƒ' ? 'ok' : log.status === 'ì§€ê°' ? 'wait' : 'reject';
          const approvalStatus = log.approved ? 'ìŠ¹ì¸ ì™„ë£Œ' : 'ìŠ¹ì¸ ëŒ€ê¸°';
          
          html += `
            <div class="card row-card">
              <a href="#" class="link-soft" onclick="openSheet('ê·¼ë¬´ ìƒì„¸','<div><b>ì¼ì</b> ${log.date}</div><div><b>ì¶œê·¼</b> ${log.in}</div><div><b>í‡´ê·¼</b> ${log.out}</div><div><b>íœ´ê²Œ</b> ${log.breakMin}ë¶„</div><div><b>ì‹¤ê·¼ë¡œ</b> ${log.workHours.toFixed(1)}h</div><div><b>ìƒíƒœ</b> ${log.status}</div><div><b>ìŠ¹ì¸ìƒíƒœ</b> ${approvalStatus}</div>'); return false;">ìƒì„¸ë³´ê¸°</a>
              <div><span class="tag">ê·¼ë¬´</span><span class="dot ${statusClass}"></span>${formattedDate} ${log.in}~${log.out} / ${log.workHours.toFixed(1)}h (${approvalStatus})</div>
            </div>
          `;
        });
        
        html += '</div></details>';
      });
      
      historyContainer.innerHTML = html;
    }

    // ===== ìº˜ë¦°ë” ê´€ë ¨ í•¨ìˆ˜ =====
    function dayStatus(dateStr) {
      const logs = getWorkLogs();
      const log = logs[dateStr];
      
      if (!log) {
        return { badge: 'ê²°ê·¼', cls: 'b-absent', hrs: '0.0h' };
      }
      
      const workHours = log.workHours || 0;
      const hrs = workHours.toFixed(1) + 'h';
      
      if (log.status === 'ì§€ê°') {
        return { badge: 'ì§€ê°', cls: 'b-late', hrs: hrs };
      }
      
      if (workHours === 0) {
        return { badge: 'ê²°ê·¼', cls: 'b-absent', hrs: '0.0h' };
      }
      
      return { badge: 'ì •ìƒ', cls: 'b-normal', hrs: hrs };
    }

    function buildCalendarPage(year, month) {
      const grid = document.getElementById('cal-grid');
      const title = document.getElementById('cal-title');
      
      if (!grid || !title) return;
      
      grid.innerHTML = '';
      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);
      
      title.textContent = year + '-' + String(month + 1).padStart(2, '0');
      
      // ìš”ì¼ í—¤ë”
      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      for (let i = 0; i < 7; i++) {
        const header = document.createElement('div');
        header.className = 'cal-cell';
        header.style.background = '#f9fafb';
        header.innerHTML = `<div class="cal-date" style="font-weight:700;">${dayNames[i]}</div>`;
        grid.appendChild(header);
      }
      
      // ë¹ˆì¹¸
      for (let e = 0; e < first.getDay(); e++) {
        const empty = document.createElement('div');
        empty.className = 'cal-cell';
        grid.appendChild(empty);
      }
      
      // ë‚ ì§œ
      const days = last.getDate();
      for (let day = 1; day <= days; day++) {
        const date = new Date(year, month, day);
        const dateStr = getDateString(date);
        const info = dayStatus(dateStr);
        
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        cell.innerHTML = `
          <div class="cal-date">${String(day).padStart(2, '0')}</div>
          <div class="cal-hrs">${info.hrs}</div>
          <span class="cal-badge ${info.cls}">${info.badge}</span>
        `;
        grid.appendChild(cell);
      }
    }

    function openCalendarPage() {
      const page = document.getElementById('calendar-page');
      if (page) {
        page.style.display = 'flex';
        const now = new Date();
        window.__cal_year = now.getFullYear();
        window.__cal_month = now.getMonth();
        buildCalendarPage(window.__cal_year, window.__cal_month);
      }
    }

    function closeCalendarPage() {
      const page = document.getElementById('calendar-page');
      if (page) {
        page.style.display = 'none';
      }
    }

    // ===== ì‹œíŠ¸/ìŠ¤ë‚µë°” ê´€ë ¨ í•¨ìˆ˜ =====
    function goToHistory() {
      try {
        const historyContainer = document.getElementById('history-container');
        if (historyContainer) {
          historyContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      } catch (e) {
        console.warn('íˆìŠ¤í† ë¦¬ ì´ë™ ì‹¤íŒ¨:', e);
      }
      closeSnack();
    }

    function closeSnack() {
      const snackbar = document.getElementById('snackbar');
      if (snackbar) {
        snackbar.classList.remove('show');
      }
    }

    function showSnackAction(msg, actionText, actionFn) {
      const snackbar = document.getElementById('snackbar');
      const text = document.getElementById('snackbar-text');
      const action = document.getElementById('snackbar-action');
      
      if (!snackbar || !text || !action) return;
      
      text.textContent = msg || text.textContent;
      action.textContent = actionText || action.textContent;
      action.onclick = function() {
        if (typeof actionFn === 'function') actionFn();
      };
      
      snackbar.classList.add('show');
      clearTimeout(window.__snackTimer);
      window.__snackTimer = setTimeout(closeSnack, 4000);
    }

    function openSheet(title, bodyHtml) {
      const titleEl = document.getElementById('sheet-title');
      const bodyEl = document.getElementById('sheet-body');
      const sheet = document.getElementById('sheet');
      const overlay = document.getElementById('sheet-overlay');
      
      if (titleEl && bodyEl && sheet && overlay) {
        titleEl.innerText = title || 'ìƒì„¸';
        bodyEl.innerHTML = bodyHtml || '';
        overlay.style.display = 'block';
        sheet.style.bottom = '0';
      }
    }

    function closeSheet() {
      const sheet = document.getElementById('sheet');
      const overlay = document.getElementById('sheet-overlay');
      
      if (sheet && overlay) {
        sheet.style.bottom = '-100%';
        overlay.style.display = 'none';
      }
    }

    // ===== ì œì¶œ ì²˜ë¦¬ =====
    async function submitWorkLog() {
      const inTime = document.getElementById('inTime').value;
      const outTime = document.getElementById('outTime').value;
      const breakMin = document.getElementById('breakMin').value;
      
      if (!inTime || !outTime) {
        showSnackAction('ì¶œê·¼/í‡´ê·¼ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'í™•ì¸', closeSnack);
        return;
      }
      
      const workHours = calculateWorkHours(inTime, outTime, breakMin);
      if (workHours <= 0) {
        showSnackAction('ê·¼ë¬´ì‹œê°„ì´ 0ì‹œê°„ ì´í•˜ì…ë‹ˆë‹¤. ì‹œê°„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'í™•ì¸', closeSnack);
        return;
      }
      
      const targetDate = currentSelectedDate; // í˜„ì¬ ì„ íƒëœ ë‚ ì§œì— ê¸°ë¡ ì €ì¥
      const log = {
        in: inTime,
        out: outTime,
        breakMin: parseInt(breakMin) || 0,
        approved: false
      };
      
      try {
        await saveWorkLog(targetDate, log);
        const logs = await getWorkLogs();
        renderHistory();
        updateCalculations();
        
        // ì œì¶œ í›„ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”í•˜ì§€ ì•Šê³  í˜„ì¬ ê°’ ìœ ì§€
        showSnackAction('ì œì¶œ ì™„ë£Œ. ì‚¬ì¥ ìŠ¹ì¸ ëŒ€ê¸°ì…ë‹ˆë‹¤.', 'íˆìŠ¤í† ë¦¬ë¡œ ì´ë™', goToHistory);
      } catch (error) {
        console.error('ê·¼ë¬´ ê¸°ë¡ ì œì¶œ ì‹¤íŒ¨:', error);
        showSnackAction('ì œì¶œ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'í™•ì¸', closeSnack);
      }
    }

    // ===== ì´ˆê¸°í™” =====
    document.addEventListener('DOMContentLoaded', function() {
      // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
      const todaySpan = document.getElementById('today-date');
      if (todaySpan) {
        const today = new Date();
        const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const dateStr = getDateString(today);
        todaySpan.textContent = dateStr + ' (' + dayNames[today.getDay()] + ')';
      }
      
      // ì§ì›ëª… í‘œì‹œ
      const empNameSpan = document.getElementById('empName');
      if (empNameSpan) {
        empNameSpan.textContent = getEmployeeName();
      }
      
      // ê¸°ë³¸ê°’ ë¶ˆëŸ¬ì˜¤ê¸° (ì „ë‚  ê¸°ë¡ ë˜ëŠ” ìš”ì¼ë³„ íŒ¨í„´)
      const today = getDateString();
      const logs = getWorkLogs();
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = getDateString(yesterday);
      
      if (logs[yesterdayStr]) {
        // ì „ë‚  ê¸°ë¡ì´ ìˆìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
        document.getElementById('inTime').value = logs[yesterdayStr].in;
        document.getElementById('outTime').value = logs[yesterdayStr].out;
        document.getElementById('breakMin').value = logs[yesterdayStr].breakMin;
      }
      
      // ì˜¤ëŠ˜ ê¸°ë¡ì´ ì´ë¯¸ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê¸°
      if (logs[today]) {
        document.getElementById('inTime').value = logs[today].in;
        document.getElementById('outTime').value = logs[today].out;
        document.getElementById('breakMin').value = logs[today].breakMin;
      }
      
      // íƒ€ì„ë°•ìŠ¤ ë™ê¸°í™” ë° í´ë¦­ ì´ë²¤íŠ¸
      document.querySelectorAll('.time-box').forEach(function(box) {
        const input = box.querySelector('input[type="time"]');
        const display = box.querySelector('.time-display');
        
        if (!input || !display) return;
        
        function sync() {
          display.textContent = input.value || '--:--';
          updateCalculations();
        }
        
        function openTimePicker() {
          // ëª¨ë°”ì¼ì—ì„œ showPicker() ì§€ì› í™•ì¸
          if (typeof input.showPicker === 'function') {
            try {
              input.showPicker();
            } catch (e) {
              input.focus();
              input.click();
            }
          } else {
            // ë°ìŠ¤í¬í†±ì—ì„œ í´ë¦­ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
            input.focus();
            input.click();
          }
        }
        
        sync();
        input.addEventListener('input', sync);
        input.addEventListener('change', sync);
        
        // ì „ì²´ ë°•ìŠ¤ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸°
        box.addEventListener('click', openTimePicker);
        display.addEventListener('click', openTimePicker);
        
        // í‚¤ë³´ë“œ ì ‘ê·¼ì„±
        box.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openTimePicker();
          }
        });
        
        // í¬ì»¤ìŠ¤ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸°
        box.setAttribute('tabindex', '0');
      });
      
      // íœ´ê²Œì‹œê°„ ì…ë ¥ ì´ë²¤íŠ¸
      const breakMinInput = document.getElementById('breakMin');
      if (breakMinInput) {
        breakMinInput.addEventListener('input', updateCalculations);
        breakMinInput.addEventListener('change', updateCalculations);
      }
      
      // ì œì¶œ ë²„íŠ¼ ì´ë²¤íŠ¸
      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn) {
        submitBtn.addEventListener('click', submitWorkLog);
      }
      
      // ìº˜ë¦°ë” ë„¤ë¹„ê²Œì´ì…˜
      const calPrev = document.getElementById('cal-prev');
      if (calPrev) {
        calPrev.addEventListener('click', function() {
          if (typeof window.__cal_year === 'undefined') {
            const now = new Date();
            window.__cal_year = now.getFullYear();
            window.__cal_month = now.getMonth();
          }
          window.__cal_month--;
          if (window.__cal_month < 0) {
            window.__cal_month = 11;
            window.__cal_year--;
          }
          buildCalendarPage(window.__cal_year, window.__cal_month);
        });
      }
      
      const calNext = document.getElementById('cal-next');
      if (calNext) {
        calNext.addEventListener('click', function() {
          if (typeof window.__cal_year === 'undefined') {
            const now = new Date();
            window.__cal_year = now.getFullYear();
            window.__cal_month = now.getMonth();
          }
          window.__cal_month++;
          if (window.__cal_month > 11) {
            window.__cal_month = 0;
            window.__cal_year++;
          }
          buildCalendarPage(window.__cal_year, window.__cal_month);
        });
      }
      
      const calToday = document.getElementById('cal-today');
      if (calToday) {
        calToday.addEventListener('click', function() {
          const now = new Date();
          window.__cal_year = now.getFullYear();
          window.__cal_month = now.getMonth();
          buildCalendarPage(window.__cal_year, window.__cal_month);
        });
      }
      
      const calClose = document.getElementById('cal-close');
      if (calClose) {
        calClose.addEventListener('click', closeCalendarPage);
      }
      
      // ë‚ ì§œ ì„ íƒ ê´€ë ¨ í•¨ìˆ˜ë“¤
      window.openDatePicker = function() {
        const overlay = document.getElementById('date-picker-overlay');
        const modal = document.getElementById('date-picker-modal');
        const dateInput = document.getElementById('selected-date');
        
        if (overlay && modal && dateInput) {
          // í˜„ì¬ ì„ íƒëœ ë‚ ì§œë¡œ ì„¤ì •
          dateInput.value = currentSelectedDate;
          overlay.style.display = 'block';
          modal.style.display = 'block';
        }
      };

      window.closeDatePicker = function() {
        const overlay = document.getElementById('date-picker-overlay');
        const modal = document.getElementById('date-picker-modal');
        
        if (overlay && modal) {
          overlay.style.display = 'none';
          modal.style.display = 'none';
        }
      };

      window.loadSelectedDate = function() {
        const dateInput = document.getElementById('selected-date');
        if (!dateInput || !dateInput.value) {
          window.closeDatePicker();
          return;
        }
        
        const selectedDate = dateInput.value;
        currentSelectedDate = selectedDate;
        
        // ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
        const todaySpan = document.getElementById('today-date');
        if (todaySpan) {
          const date = new Date(selectedDate + 'T00:00:00');
          const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
          const formattedDate = selectedDate + ' (' + dayNames[date.getDay()] + ')';
          
          // ì˜¤ëŠ˜ì¸ì§€ í™•ì¸í•˜ì—¬ í…ìŠ¤íŠ¸ ë³€ê²½
          const today = getDateString();
          const todayLine = document.getElementById('today-line');
          if (selectedDate === today) {
            todayLine.innerHTML = 'ì˜¤ëŠ˜: <span id="today-date">' + formattedDate + '</span>';
          } else {
            todayLine.innerHTML = 'ì„ íƒì¼: <span id="today-date">' + formattedDate + '</span>';
          }
        }
        
        // í•´ë‹¹ ë‚ ì§œì˜ ê·¼ë¬´ ê¸°ë¡ ë¡œë“œ
        const logs = getWorkLogs();
        const log = logs[selectedDate];
        
        if (log) {
          // ê¸°ì¡´ ê¸°ë¡ì´ ìˆìœ¼ë©´ ë¡œë“œ
          document.getElementById('inTime').value = log.in;
          document.getElementById('outTime').value = log.out;
          document.getElementById('breakMin').value = log.breakMin;
        } else {
          // ê¸°ë¡ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
          document.getElementById('inTime').value = EXPECTED_SCHEDULE.start;
          document.getElementById('outTime').value = EXPECTED_SCHEDULE.end;
          document.getElementById('breakMin').value = EXPECTED_SCHEDULE.breakMin;
        }
        
        // ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.time-box').forEach(function(box) {
          const input = box.querySelector('input[type="time"]');
          const display = box.querySelector('.time-display');
          if (input && display) {
            display.textContent = input.value || '--:--';
          }
        });
        
        // ê³„ì‚° ì—…ë°ì´íŠ¸
        updateCalculations();
        window.closeDatePicker();
      };
      
      // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
      async function initializeApp() {
        try {
          console.log('ğŸš€ ì•± ì´ˆê¸°í™” ì‹œì‘...');
          
          // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸
          const isConnected = await checkDatabaseConnection();
          if (!isConnected) {
            console.log('âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨, ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì „í™˜');
            const logs = getWorkLogsLocal();
            renderHistory();
            updateCalculations();
            return;
          }
          
          console.log('ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„° ë¡œë“œ ì¤‘...');
          
          // ì§ì› ì •ë³´ ë¡œë“œ
          const employeeInfo = await getEmployeeInfo();
          if (employeeInfo) {
            document.getElementById('empName').textContent = employeeInfo.name;
            if (employeeInfo.hourly_wage) {
              saveHourlyWage(employeeInfo.hourly_wage);
            }
          }
          
          // ê·¼ë¬´ ê¸°ë¡ ë¡œë“œ
          const logs = await getWorkLogs();
          console.log('ğŸ“‹ ë¡œë“œëœ ê·¼ë¬´ ê¸°ë¡:', Object.keys(logs).length, 'ê°œ');
          
          // UI ì—…ë°ì´íŠ¸
          await renderHistory();
          await updateCalculations();
          
          // í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¶”ê°€ (ê°œë°œìš©)
          if (Object.keys(logs).length === 0) {
            console.log('í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€ ì¤‘...');
            const testData = {
              '2024-09-29': { in: '09:00', out: '18:00', breakMin: 60, approved: true },
              '2024-09-30': { in: '09:00', out: '18:00', breakMin: 60, approved: true },
              '2024-10-01': { in: '09:00', out: '18:00', breakMin: 60, approved: true },
              '2024-10-02': { in: '09:00', out: '18:00', breakMin: 60, approved: true },
              '2024-10-03': { in: '09:00', out: '18:00', breakMin: 60, approved: true },
              '2024-10-07': { in: '09:00', out: '18:00', breakMin: 60, approved: true },
              '2024-10-08': { in: '09:00', out: '18:00', breakMin: 60, approved: true },
              '2024-10-09': { in: '09:00', out: '18:00', breakMin: 60, approved: true },
              '2024-10-10': { in: '09:00', out: '18:00', breakMin: 60, approved: true },
              '2024-10-11': { in: '09:00', out: '18:00', breakMin: 60, approved: true }
            };
            
            for (const [date, log] of Object.entries(testData)) {
              await saveWorkLog(date, log);
            }
            
            // ë‹¤ì‹œ ë Œë”ë§
            const newLogs = await getWorkLogs();
            renderHistory();
            updateCalculations();
            
            console.log('í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€ ì™„ë£Œ!');
          }
          
        } catch (error) {
          console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
          // ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì „í™˜
          console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì „í™˜...');
          const logs = getWorkLogsLocal();
          renderHistory();
          updateCalculations();
        }
      }
      
      // ì•± ì´ˆê¸°í™” ì‹¤í–‰
      initializeApp();
    });

    // ===== ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ =====
    window.openCalendarPage = openCalendarPage;
    window.closeCalendarPage = closeCalendarPage;
    window.buildCalendarPage = buildCalendarPage;
    window.dayStatus = dayStatus;
    window.openSheet = openSheet;
    window.closeSheet = closeSheet;
  </script>
</body>
</html>
